# Multi-stage build for A2A Agent
ARG MICRODIR=/microdir
ARG BUILD_PACKAGES="python3-pip"
ARG PACKAGES_TO_INSTALL="python3.12 tzdata python3-requests python3-dateutil libstdc++"

FROM registry.access.redhat.com/ubi10/ubi-micro AS base
FROM registry.access.redhat.com/ubi10 AS build

ARG MICRODIR
ARG PACKAGES_TO_INSTALL

# Create micro directory
RUN mkdir ${MICRODIR}
COPY --from=base / ${MICRODIR}

# Install build dependencies
RUN yum install --releasever 10 -y python3-pip

# Install runtime packages
RUN yum install \
  --installroot ${MICRODIR} \
  --releasever 10 \
  --setopt install_weak_deps=false \
  -y \
  ${PACKAGES_TO_INSTALL}

RUN yum clean all --installroot ${MICRODIR}

# Copy application files
COPY requirements.txt ${MICRODIR}/app/requirements.txt
COPY config/*.py ${MICRODIR}/app/config/
COPY agent/*.py ${MICRODIR}/app/agent/
COPY services/*.py ${MICRODIR}/app/services/
COPY __init__.py ${MICRODIR}/app/

# Install Python dependencies
RUN python3 -m pip install --root ${MICRODIR} --no-cache-dir -r ${MICRODIR}/app/requirements.txt

# Set permissions
RUN chown -R 1001:0 ${MICRODIR}/app/ && \
    chmod -R g=u ${MICRODIR}/app/

# Final stage
FROM scratch AS image
ARG MICRODIR

COPY --from=build ${MICRODIR}/ .
USER 1001
WORKDIR /app
EXPOSE 8001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD python3 -c "import sys; sys.exit(0)"

# Start A2A agent (as a service)
CMD ["python3", "-m", "agent.a2a_agent"]